<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Điều Khiển IoT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://unpkg.com/mqtt@5.0.0/dist/mqtt.min.js"></script>
    <style>
        .collapse-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }
        .collapse-content.hidden {
            max-height: 0;
            opacity: 0;
        }
        .collapse-content:not(.hidden) {
            max-height: 500px;
            opacity: 1;
        }
        button.on { background: #2e7d32; color: white; }
        button.off { background: #bdbdbd; color: white; }
        button.disabled { background: #e0e0e0; color: white; cursor: not-allowed; opacity: 0.6; }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white text-teal-900 p-3 shadow-sm sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Bảng Điều Khiển IoT</h1>
            <div class="flex space-x-2">
                <button id="manualMode" class="px-3 py-1 bg-teal-500 text-white rounded-md hover:bg-teal-600 transition-all">Thủ Công</button>
                <button id="autoMode" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-all">Tự Động</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-3 flex-grow flex flex-col md:flex-row gap-3">
        <!-- Sidebar -->
        <aside class="w-full md:w-1/3 bg-white rounded-lg shadow-sm p-4">
            <h2 class="text-lg font-semibold text-teal-900 mb-3">Điều Khiển</h2>

            <!-- Device Status -->
            <div class="mb-4">
                <h3 class="text-md font-medium text-teal-900 mb-2">Trạng Thái Thiết Bị</h3>
                <div class="space-y-2">
                    <p class="text-teal-900">Máy Bơm: <span id="pumpStatus" class="font-bold">TẮT</span></p>
                    <p class="text-teal-900">Đèn: <span id="lightStatus" class="font-bold">TẮT</span></p>
                    <p class="text-teal-900">Mực Nước: <span id="waterStatus" class="font-bold">Nước Còn</span></p>
                </div>
            </div>

            <!-- Manual Control -->
            <div class="mb-4">
                <button id="manualToggle" class="w-full text-left text-teal-900 font-medium flex justify-between items-center">
                    Điều Khiển Thủ Công
                    <svg class="w-5 h-5 transform transition-transform" id="manualArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="manualControls" class="collapse-content pt-2">
                    <div class="space-y-3">
                        <div>
                            <button id="pumpToggle" class="w-full px-3 py-2 off rounded-md transition-all">Bật Máy Bơm</button>
                        </div>
                        <div>
                            <button id="lightToggle" class="w-full px-3 py-2 off rounded-md transition-all">Bật Đèn</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Automatic Control -->
            <div>
                <button id="autoToggle" class="w-full text-left text-teal-900 font-medium flex justify-between items-center">
                    Điều Khiển Tự Động
                    <svg class="w-5 h-5 transform transition-transform" id="autoArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="autoControls" class="collapse-content hidden pt-2">
                    <div class="space-y-3">
                        <div>
                            <label for="moistureThreshold" class="block text-teal-900 text-sm">Độ Ẩm Đất (%): <span id="moistureValue" class="font-medium">50</span></label>
                            <input id="moistureThreshold" type="range" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg accent-teal-500 cursor-pointer">
                        </div>
                        <div>
                            <label for="lightThreshold" class="block text-teal-900 text-sm">Ánh Sáng (lux): <span id="lightValue" class="font-medium">500</span></label>
                            <input id="lightThreshold" type="range" min="0" max="1000" value="500" class="w-full h-2 bg-gray-200 rounded-lg accent-teal-500 cursor-pointer">
                        </div>
                        <button id="saveThresholds" class="w-full px-3 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 transition-all">Lưu Ngưỡng</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Charts -->
        <section class="w-full md:w-2/3 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h2 class="text-sm font-semibold text-teal-900 mb-2">Nhiệt Độ Không Khí (°C)</h2>
                <canvas id="tempChart"></canvas>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h2 class="text-sm font-semibold text-teal-900 mb-2">Độ Ẩm Không Khí (%)</h2>
                <canvas id="humidityChart"></canvas>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h2 class="text-sm font-semibold text-teal-900 mb-2">Độ Ẩm Đất (%)</h2>
                <canvas id="moistureChart"></canvas>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h2 class="text-sm font-semibold text-teal-900 mb-2">Cường Độ Ánh Sáng (lux)</h2>
                <canvas id="lightChart"></canvas>
            </div>
        </section>

        <!-- Warning Popup -->
        <div id="waterWarning" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-20">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 class="text-lg font-semibold text-teal-900 mb-4">Cảnh Báo Mực Nước</h3>
                <p class="text-teal-900 mb-4">Nước đã cạn! Vui lòng kiểm tra và bổ sung nước.</p>
                <button id="closeWarning" class="w-full px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 transition-all">Đóng</button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white text-teal-900 p-3 text-center text-sm shadow-inner">
        © 2025 Hệ Thống IoT | <a href="mailto:support@iot.com" class="underline hover:text-teal-700">support@iot.com</a>
    </footer>

    <script>
        // MQTT Setup
        const clientId = 'web_' + Math.random().toString(16).substr(2, 8);
        const options = {
            clientId: clientId,
            clean: true,
            connectTimeout: 4000,
            username: 'Tuoi_cay',
            password: 'Tuoi_cay1',
            reconnectPeriod: 1000
        };
        const client = mqtt.connect('wss://a7e103b17493474fb922fbc4a7a81412.s1.eu.hivemq.cloud:8884/mqtt', options);

        client.on('connect', () => {
            console.log('Đã kết nối tới HiveMQ');
            client.subscribe('iot/sensors/temperature', { qos: 1 });
            client.subscribe('iot/sensors/air_humidity', { qos: 1 });
            client.subscribe('iot/sensors/soil_moisture', { qos: 1 });
            client.subscribe('iot/sensors/light_intensity', { qos: 1 });
            client.subscribe('iot/relay/pump', { qos: 1 });
            client.subscribe('iot/relay/light', { qos: 1 });
            client.subscribe('iot/sensors/water_level', { qos: 1 });
        });

        client.on('error', (err) => {
            console.error('Lỗi MQTT:', err);
            alert('Không thể kết nối tới HiveMQ. Vui lòng kiểm tra mạng hoặc thử tắt CORS trong trình duyệt.');
        });

        client.on('close', () => {
            console.log('Mất kết nối, thử kết nối lại...');
        });

        client.on('reconnect', () => {
            console.log('Đang thử kết nối lại...');
        });

        // Chart Setup
        const maxDataPoints = 20;
        const tempChart = new Chart(document.getElementById('tempChart').getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Nhiệt Độ (°C)', data: [], borderColor: '#2dd4bf', fill: false, tension: 0.3 }] },
            options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
        const humidityChart = new Chart(document.getElementById('humidityChart').getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Độ Ẩm (%)', data: [], borderColor: '#2dd4bf', fill: false, tension: 0.3 }] },
            options: { scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
        });
        const moistureChart = new Chart(document.getElementById('moistureChart').getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Độ Ẩm Đất (%)', data: [], borderColor: '#2dd4bf', fill: false, tension: 0.3 }] },
            options: { scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
        });
        const lightChart = new Chart(document.getElementById('lightChart').getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Cường Độ Ánh Sáng (lux)', data: [], borderColor: '#2dd4bf', fill: false, tension: 0.3 }] },
            options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });

        // Update Chart Data
        function updateChart(chart, value) {
            const time = new Date().toLocaleTimeString();
            chart.data.labels.push(time);
            chart.data.datasets[0].data.push(value);
            if (chart.data.labels.length > maxDataPoints) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update();
        }

        // Device and Water Status
        let waterLevel = 'FULL';
        let pumpStatus = 'OFF';
        let lightStatus = 'OFF';
        const pumpToggle = document.getElementById('pumpToggle');
        const waterWarning = document.getElementById('waterWarning');
        const closeWarning = document.getElementById('closeWarning');

        // MQTT Message Handling
        client.on('message', (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                switch (topic) {
                    case 'iot/sensors/temperature':
                        updateChart(tempChart, data.value);
                        break;
                    case 'iot/sensors/air_humidity':
                        updateChart(humidityChart, data.value);
                        break;
                    case 'iot/sensors/soil_moisture':
                        updateChart(moistureChart, data.value);
                        break;
                    case 'iot/sensors/light_intensity':
                        updateChart(lightChart, data.value);
                        break;
                    case 'iot/relay/pump':
                        pumpStatus = data.status;
                        document.getElementById('pumpStatus').textContent = data.status === 'ON' ? 'BẬT' : 'TẮT';
                        pumpToggle.textContent = data.status === 'ON' ? 'Tắt Máy Bơm' : 'Bật Máy Bơm';
                        pumpToggle.className = data.status === 'ON' ? 'w-full px-3 py-2 on rounded-md transition-all' : 'w-full px-3 py-2 off rounded-md transition-all';
                        break;
                    case 'iot/relay/light':
                        lightStatus = data.status;
                        document.getElementById('lightStatus').textContent = data.status === 'ON' ? 'BẬT' : 'TẮT';
                        document.getElementById('lightToggle').textContent = data.status === 'ON' ? 'Tắt Đèn' : 'Bật Đèn';
                        document.getElementById('lightToggle').className = data.status === 'ON' ? 'w-full px-3 py-2 on rounded-md transition-all' : 'w-full px-3 py-2 off rounded-md transition-all';
                        break;
                    case 'iot/sensors/water_level':
                        waterLevel = data.status;
                        document.getElementById('waterStatus').textContent = waterLevel === 'FULL' ? 'Nước Còn' : 'Nước Hết';
                        if (waterLevel === 'EMPTY') {
                            waterWarning.classList.remove('hidden');
                            pumpToggle.disabled = true;
                            pumpToggle.className = 'w-full px-3 py-2 disabled rounded-md transition-all';
                            client.publish('iot/alert/water_level', JSON.stringify({ message: 'Nước Hết' }), { qos: 1 }, err => {
                                if (err) console.error('Publish error:', err);
                            });
                        } else {
                            waterWarning.classList.add('hidden');
                            pumpToggle.disabled = false;
                            pumpToggle.className = pumpStatus === 'ON' ? 'w-full px-3 py-2 on rounded-md transition-all' : 'w-full px-3 py-2 off rounded-md transition-all';
                        }
                        break;
                }
            } catch (e) {
                console.error('Lỗi phân tích JSON:', e);
            }
        });

        // Close Warning Popup
        closeWarning.addEventListener('click', () => {
            waterWarning.classList.add('hidden');
        });

        // Mode Control
        const manualModeBtn = document.getElementById('manualMode');
        const autoModeBtn = document.getElementById('autoMode');
        const manualControls = document.getElementById('manualControls');
        const autoControls = document.getElementById('autoControls');

        manualModeBtn.addEventListener('click', () => {
            manualControls.classList.remove('hidden');
            autoControls.classList.add('hidden');
            manualModeBtn.classList.add('bg-teal-500', 'text-white');
            manualModeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            autoModeBtn.classList.add('bg-gray-200', 'text-gray-700');
            autoModeBtn.classList.remove('bg-teal-500', 'text-white');
            client.publish('iot/control/mode', 'manual', { qos: 1 }, err => {
                if (err) console.error('Publish error:', err);
            });
        });

        autoModeBtn.addEventListener('click', () => {
            manualControls.classList.add('hidden');
            autoControls.classList.remove('hidden');
            autoModeBtn.classList.add('bg-teal-500', 'text-white');
            autoModeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            manualModeBtn.classList.add('bg-gray-200', 'text-gray-700');
            manualModeBtn.classList.remove('bg-teal-500', 'text-white');
            client.publish('iot/control/mode', 'automatic', { qos: 1 }, err => {
                if (err) console.error('Publish error:', err);
            });
        });

        // Collapsible Sections
        const manualToggle = document.getElementById('manualToggle');
        const autoToggle = document.getElementById('autoToggle');
        const manualArrow = document.getElementById('manualArrow');
        const autoArrow = document.getElementById('autoArrow');

        manualToggle.addEventListener('click', () => {
            manualControls.classList.toggle('hidden');
            manualArrow.classList.toggle('rotate-180');
        });

        autoToggle.addEventListener('click', () => {
            autoControls.classList.toggle('hidden');
            autoArrow.classList.toggle('rotate-180');
        });

        // Toggle Buttons
        const lightToggle = document.getElementById('lightToggle');

        pumpToggle.addEventListener('click', () => {
            if (waterLevel === 'EMPTY') {
                waterWarning.classList.remove('hidden');
                return;
            }
            const newState = document.getElementById('pumpStatus').textContent === 'BẬT' ? 'OFF' : 'ON';
            client.publish('iot/control/pump', newState, { qos: 1 }, err => {
                if (err) console.error('Publish error:', err);
            });
        });

        lightToggle.addEventListener('click', () => {
            const newState = document.getElementById('lightStatus').textContent === 'BẬT' ? 'OFF' : 'ON';
            client.publish('iot/control/light', newState, { qos: 1 }, err => {
                if (err) console.error('Publish error:', err);
            });
        });

        // Automatic Thresholds
        const moistureThreshold = document.getElementById('moistureThreshold');
        const lightThreshold = document.getElementById('lightThreshold');
        const moistureValue = document.getElementById('moistureValue');
        const lightValue = document.getElementById('lightValue');
        const saveThresholds = document.getElementById('saveThresholds');

        moistureThreshold.addEventListener('input', () => {
            moistureValue.textContent = moistureThreshold.value;
        });
        lightThreshold.addEventListener('input', () => {
            lightValue.textContent = lightThreshold.value;
        });

        saveThresholds.addEventListener('click', () => {
            const thresholds = {
                soil_moisture: parseInt(moistureThreshold.value),
                light_intensity: parseInt(lightThreshold.value),
                water_available: waterLevel === 'FULL'
            };
            client.publish('iot/control/thresholds', JSON.stringify(thresholds), { qos: 1 }, err => {
                if (err) console.error('Publish error:', err);
            });
        });
    </script>
</body>
</html>